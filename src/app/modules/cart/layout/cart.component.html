<div class="border-bottom bg-white">
  <apt-breadcrumb [label]="'COMMON.CHECKOUT' | translate" [breadcrumbs]="breadcrumbs" [autoGenerated]="false">
  </apt-breadcrumb>
</div>

<ng-container *ngIf="cart">
  <div class="container-fluid px-5 py-4" id="checkout-form">
    <apt-mini-profile #profile></apt-mini-profile>

    <h4 class="mb-3 text-muted">{{'CART.CHECKOUT' | translate}}</h4>
    <div class="row">
      <div class="col-md-4 order-md-2 mb-4">
        <apt-price-summary [record]="cart" [form]="form" [page]="pricingSummaryType" [loading]="loading"
        (onSubmitOrder)="submitOrder()" #priceSummary>
        </apt-price-summary>
        <cart-summary [cart]="cart"></cart-summary>
      </div>
      <div class="col-md-8 order-md-1">
        <div class="mb-3" *ngIf="isLoggedIn" [ngClass]="isLoggedIn ? 'mt-2' : 'mt-4'">
          <h5 class="mb-0 text-muted">{{'CART.BILLING_AND_SHIPPING_INFORMATION' | translate}}</h5>
          <small>{{'CART.ENTER_SHIPPING_ADDRESS' | translate}}</small>
        </div>
        <div class="card p-3">
          <form class="needs-validation" novalidate #form="ngForm">
            <div class="row" *ngIf="!isLoggedIn">
              <div class="col-12 col-md-6">
                <apt-input-field name="orderName" [entity]="order" [field]="'Name'" [(ngModel)]="order.Name"
                  [required]="true" [label]="'MY_ACCOUNT.DASHBOARD.ORDER_NAME' | translate"
                  [errorMsg]="errMessages.requiredOrderName"></apt-input-field>
              </div>
            </div>
            <tabset #staticTabs *ngIf="primaryContact">
              <tab heading="{{'CART.BILLING_ADDRESS' | translate}}" id="billing">
                <!-- Checkout form for guest user -->
                <div *ngIf="!isLoggedIn else showBillingAddressTemplate">
                  <div class="row mt-3">
                    <div class="col-md-6">
                      <apt-input-field name="firstName" [labelClass]="'font-weight-normal'" [entity]="primaryContact"
                        [field]="'FirstName'" [required]="true" [(ngModel)]="primaryContact.FirstName"
                        [errorMsg]="errMessages.requiredFirstName">
                      </apt-input-field>
                    </div>
                    <div class="col-md-6">
                      <apt-input-field name="lastName" [labelClass]="'font-weight-normal'" [entity]="primaryContact"
                        [field]="'LastName'" [required]="true" [(ngModel)]="primaryContact.LastName"
                        [errorMsg]="errMessages.requiredLastName">
                      </apt-input-field>
                    </div>
                    <div class="col-md-6">
                      <apt-input-field name="email" [labelClass]="'font-weight-normal'"
                        [placeholder]="'you@example.com'" [entity]="primaryContact" [field]="'Email'" [required]="true"
                        [(ngModel)]="primaryContact.Email" [errorMsg]="errMessages.requiredEmail">
                      </apt-input-field>
                    </div>
                  </div>
                  <apt-address [(ngModel)]="primaryContact" type="Billing" name="billingAddress" [form]="form">
                  </apt-address>
                </div>
                <ng-template #showBillingAddressTemplate>
                  <div class="pt-3 px-3">
                    <apt-input-field name="billTo" [labelClass]="'font-weight-normal'" [entity]="order"
                      [field]="'BillToAccount'" [(ngModel)]="order.BillToAccount" (ngModelChange)="onBillToChange()">
                    </apt-input-field>
                    <div *ngIf="billToAccount$ | async as billAccount">
                      <apt-address [value]="billAccount" [type]="'Billing'" [readonly]="true"></apt-address>
                    </div>
                    <div class="pt-3">
                      <apt-input-field name="primaryContact" [labelClass]="'font-weight-normal'" [entity]="order"
                        [field]="'PrimaryContact'" [(ngModel)]="order.PrimaryContact" [lookupOptions]="lookupOptions"
                        [required]="true" [errorMsg]="errMessages.requiredPrimaryContact">
                      </apt-input-field>
                    </div>
                  </div>
                </ng-template>
              </tab>
              <tab heading="{{'CART.SHIPPING_ADDRESS' | translate}}" [disabled]="shippingEqualsBilling" id="shipping">
                <div *ngIf="!isLoggedIn else showShippingAddressTemplate">
                  <apt-address [(ngModel)]="primaryContact" type="Shipping" name="shippingAddress" [form]="form">
                  </apt-address>
                </div>
                <ng-template #showShippingAddressTemplate>
                  <div class="pt-3 px-3">
                    <apt-input-field name="shipTo" [labelClass]="'font-weight-normal'" [entity]="order"
                      [field]="'ShipToAccount'" [(ngModel)]="order.ShipToAccount" (ngModelChange)="onShipToChange()"
                      [required]="true" [errorMsg]="errMessages.requiredShipToAcc">
                    </apt-input-field>
                    <div *ngIf="shipToAccount$ | async as shipAccount">
                      <apt-address [value]="shipAccount" [type]="'Shipping'" [readonly]="true"></apt-address>
                    </div>
                  </div>
                </ng-template>
              </tab>
            </tabset>

            <hr class="mb-4">
            <div class="custom-control custom-checkbox">
              <input type="checkbox" class="custom-control-input" id="same-address" (ngModelChange)="selectTab($event)"
                [(ngModel)]="shippingEqualsBilling" name="shippingEqualsBilling">
              <label class="custom-control-label pt-1" for="same-address">{{'CART.SHIPPING_AS_BILLING' |
                translate}}</label>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <ng-template #confirmationTemplate>
    <div class="modal-header align-items-center d-flex flex-row-reverse p-0 pb-2 mt-3 border-bottom border-secondary">
      <button type="button" class="close close-button pull-right pr-0" aria-label="Close" (click)="confirmationModal.hide()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body bg-white d-flex flex-column justify-content-center py-4">
      <h6 class="modal-title pull-left font-weight-bold pb-2">
        {{'MANAGE_CART.CART_SUMMARY.CHECKOUT' | translate}}
      </h6>
      <p class="text-center"><strong>{{ 'MODAL.THANK_YOU' | translate }}
          {{order?.PrimaryContact?.FirstName}}!</strong></p>
      <small class="text-center" *ngIf="order?.PrimaryContact?.Email; else noEmail"
        [translate]="'CART.SUCCESSFUL_ORDER_CREATION_MESSAGE'"
        [translateParams]="{emailAddress: order?.PrimaryContact?.Email}"></small>
      <h5 class="text-center my-3" [translate]="'DETAILS.GENERATED_ORDER_NUMBER'"
        [translateParams]="{orderName: orderConfirmation?.Name}"></h5>
      <button class="btn btn-outline-primary w-25 mx-auto" (click)="closeModal()">{{ 'DETAILS.VIEW_YOUR_ORDER' |
        translate }}</button>
    </div>
  </ng-template>

  <ng-template #noEmail>
    <small class="text-center">{{ 'CART.SUCCESSFUL_ORDER_CREATION_MESSAGE_WITHOUT_EMAIL' |
      translate }}</small>
  </ng-template>
</ng-container>
